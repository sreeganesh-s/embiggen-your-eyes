<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StellarScope: Ultimate NASA Image Explorer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load OpenSeadragon for smooth deep zoom functionality -->
    <script src="https://cdn.jsdelivr.net/npm/openseadragon@4.1.1/build/openseadragon/openseadragon.min.js"></script>
    <!-- Load Inter font and Phosphor Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/phosphor-icons"></script>
    <style>
        /* Base Styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #030712; /* Darkest Slate */
            color: #f8fafc; /* Lightest Text */
            height: 100vh;
            overflow: hidden; /* Prevent scroll on initial load */
            position: relative;
        }

        /* ----------------------------------------------------- */
        /* PARALLAX & BACKGROUND ANIMATION SETUP                 */
        /* ----------------------------------------------------- */
        
        /* The background layers apply to the body, but are controlled by JS/CSS */
        
        /* Layer 1: Nebula Background (Slowest Drift) - Using uploaded image */
        #background-layer-1 {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Using the uploaded galaxy image for the background texture */
            background-image: url('uploaded:galaxy-background-9060748.jpg-b9a69b3b-934c-4ea8-953b-c06f04d6f8a3'); 
            background-size: cover;
            background-position: center;
            opacity: 0.2;
            z-index: -3;
            animation: nebula-drift 180s linear infinite;
        }

        /* Layer 2 & 3 Star fields (CSS Gradients for faster, less resource-intensive animation) */
        #background-layer-2 {
            position: fixed;
            top: 0;
            left: 0;
            width: 200%;
            height: 200%;
            background-image: radial-gradient(#ffffff 1px, transparent 1px), radial-gradient(#ffffff 1px, transparent 1px);
            background-size: 100px 100px;
            background-position: 0 0;
            opacity: 0.4;
            z-index: -2;
            animation: star-field-drift 90s linear infinite;
        }
        
        #background-layer-3 {
            position: fixed;
            top: 0;
            left: 0;
            width: 250%; 
            height: 250%;
            background-image: radial-gradient(rgba(255, 255, 255, 0.8) 0.5px, transparent 0.5px);
            background-size: 50px 50px;
            background-position: 0 0;
            opacity: 0.6;
            z-index: -1;
            animation: star-field-drift 60s linear infinite reverse;
        }

        /* --- Keyframe Animations for Movement --- */
        @keyframes nebula-drift {
            0% { transform: translate(0, 0); }
            100% { transform: translate(5%, 5%); }
        }
        
        @keyframes star-field-drift {
            0% { background-position: 0 0; }
            100% { background-position: 100% 100%; }
        }

        /* ----------------------------------------------------- */
        /* HERO & APP STYLING                                    */
        /* ----------------------------------------------------- */
        .bg-slate-800, .bg-slate-700 {
            background-color: rgba(30, 41, 59, 0.9) !important; /* 90% opacity for main panels */
        }
        #status-panel {
            background-color: rgba(51, 65, 85, 0.9) !important;
        }
        .osd-viewer {
            width: 100%;
            height: 100%;
            background-color: #000;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .control-btn {
            @apply flex items-center justify-center p-2 rounded-lg text-white font-medium transition duration-200;
        }
        .control-btn:hover {
             @apply shadow-md;
        }
        
        /* CTA Button Styling from Landing Page */
        .cta-button {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .cta-button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.4), 0 6px 6px rgba(79, 70, 229, 0.2);
            background-color: #6366f1;
        }
    </style>
</head>
<body>

    <!-- Parallax Background Layers (Always Visible) -->
    <div id="background-layer-1"></div>
    <div id="background-layer-2"></div>
    <div id="background-layer-3"></div>

    <!-- 1. LANDING PAGE SECTION (Visible by Default) -->
    <section id="landing-page" class="absolute inset-0 flex flex-col items-center justify-center text-center p-8 z-10 bg-slate-900/90 transition-opacity duration-500">
        <div class="max-w-xl mx-auto p-10 bg-slate-800 rounded-2xl shadow-2xl backdrop-blur-sm">
            <h1 class="text-6xl font-extrabold text-indigo-400 mb-4">StellarScope</h1>
            <p class="text-xl text-slate-300 mb-8">
                Prepare for launch. Explore the cosmic frontier with NASA data, deep-zoom technology, and collaborative labeling.
            </p>
            <button onclick="startApp()" class="cta-button inline-flex items-center space-x-2 px-10 py-4 bg-indigo-700 text-white text-xl font-bold rounded-full">
                <i class="ph-bold ph-telescope text-2xl"></i>
                <span>LAUNCH SIMULATION</span>
            </button>
        </div>
    </section>

    <!-- 2. MAIN APPLICATION EXPLORER (Hidden by Default) -->
    <div id="main-app" class="p-4 flex flex-col min-h-screen fixed inset-0 hidden transition-opacity duration-500">
        <header class="mb-4 bg-slate-800 p-4 rounded-xl shadow-2xl">
            <h1 class="text-3xl font-extrabold text-indigo-400 flex items-center">
                <i class="ph-bold ph-planet mr-2 text-4xl"></i> StellarScope
                <span class="text-sm font-medium ml-3 text-slate-400 hidden sm:inline">NASA Deep Space Viewer</span>
            </h1>
        </header>

        <!-- Main Content Area -->
        <main class="flex-grow flex flex-col lg:flex-row gap-4 overflow-y-auto">

            <!-- Sidebar / Control Panel -->
            <aside id="control-panel" class="bg-slate-800 p-4 rounded-xl shadow-lg w-full lg:w-80 lg:h-full flex-shrink-0 order-2 lg:order-1 overflow-y-auto">
                <h2 class="text-xl font-semibold mb-4 text-indigo-300 border-b border-indigo-700 pb-2">Exploration Tools</h2>

                <!-- Status/User Info (Firebase) -->
                <div id="status-panel" class="mb-4 text-sm bg-slate-700 p-3 rounded-lg shadow">
                    <p class="font-medium text-slate-300">User ID: <span id="user-id" class="font-mono text-xs text-indigo-400">Loading...</span></p>
                    <p id="label-count" class="text-xs text-slate-400 mt-1">Total community labels: 0</p>
                    <div id="firestore-error" class="text-red-400 text-xs mt-1 hidden"></div>
                </div>

                <!-- Feature: Coordinate Search & Navigation (Local Function) -->
                <div class="mb-6">
                    <h3 class="font-semibold text-lg mb-2 text-slate-200">Coordinate Search (X, Y)</h3>
                    <input id="coord-search" type="text" placeholder="Search: e.g. 0.5, 0.5, 3.0 (Zoom level optional)"
                           class="w-full p-2 rounded-lg bg-slate-700 text-slate-50 border border-slate-600 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                    <button onclick="searchCoordinates()" class="w-full mt-2 control-btn bg-indigo-500 hover:bg-indigo-600">
                        <i class="ph-fill ph-magnifying-glass mr-2"></i> Go to Location
                    </button>
                    <!-- Local feedback area -->
                    <div id="search-feedback" class="text-xs mt-2 text-slate-400 italic min-h-6">Ready for coordinates. (0.0 to 1.0)</div>
                </div>
                
                <!-- Feature: Image Switching Gallery -->
                <div class="mb-6">
                    <h3 class="font-semibold text-lg mb-2 text-slate-200">Image Gallery</h3>
                    <p class="text-xs text-slate-400 mb-2">Instantly load a new dataset.</p>
                    <div class="grid grid-cols-2 gap-2">
                        <!-- All gallery buttons now use the same test link -->
                        <button onclick="loadNewImage('image1')" class="control-btn bg-green-800 hover:bg-green-700 text-sm">
                            <i class="ph-bold ph-galaxy mr-1"></i> Carina Nebula
                        </button>
                        <button onclick="loadNewImage('image2')" class="control-btn bg-green-800 hover:bg-green-700 text-sm">
                            <i class="ph-bold ph-star-four mr-1"></i> Pillars
                        </button>
                        <button onclick="loadNewImage('image3')" class="control-btn bg-green-800 hover:bg-green-700 text-sm">
                            <i class="ph-bold ph-grid-four mr-1"></i> Jupiter
                        </button>
                        <button onclick="loadNewImage('image4')" class="control-btn bg-green-800 hover:bg-green-700 text-sm">
                            <i class="ph-bold ph-globe mr-1"></i> Tarantula
                        </button>
                    </div>
                </div>


                <!-- Feature: Multispectral Layers (Simulated) -->
                <div class="mb-6">
                    <h3 class="font-semibold text-lg mb-2 text-slate-200">Multispectral Layers</h3>
                    <div class="flex flex-col space-y-2">
                        <label class="flex items-center text-sm text-slate-300">
                            <input type="checkbox" id="layer-rgb" checked disabled class="rounded text-indigo-500 bg-slate-700 border-slate-600 mr-2">
                            Standard (RGB)
                        </label>
                        <label class="flex items-center text-sm text-slate-300">
                            <input type="checkbox" id="layer-ir" onclick="toggleMultispectralLayer('IR')" class="rounded text-indigo-500 bg-slate-700 border-slate-600 mr-2">
                            Infrared (IR) <span class="text-xs ml-2 text-yellow-400">(Simulated)</span>
                        </label>
                        <label class="flex items-center text-sm text-slate-300">
                            <input type="checkbox" id="layer-alt" onclick="toggleMultispectralLayer('Altimetry')" class="rounded text-indigo-500 bg-slate-700 border-slate-600 mr-2">
                            Altimetry
                        </label>
                    </div>
                </div>

                <!-- Feature: Community Labeling (Firestore) -->
                <div class="mb-6">
                    <h3 class="font-semibold text-lg mb-2 text-slate-200">Community Labeling</h3>
                    <input id="label-text" type="text" placeholder="Enter feature name (e.g. 'New Crater')"
                           class="w-full p-2 rounded-lg bg-slate-700 text-slate-50 border border-slate-600 focus:ring-indigo-500 focus:border-indigo-500 text-sm mb-2">
                    <button id="add-label-btn" onclick="addCommunityLabel()" class="w-full control-btn bg-green-600 hover:bg-green-700">
                        <i class="ph-fill ph-push-pin-simple mr-2"></i> Add Label at Center
                    </button>
                    <div id="labels-list" class="mt-3 max-h-40 overflow-y-auto space-y-1">
                        <!-- Labels will be dynamically injected here -->
                    </div>
                </div>

            </aside>

            <!-- Viewer Area -->
            <section id="viewer-container" class="flex-grow min-h-[60vh] lg:min-h-full flex flex-col order-1 lg:order-2">
                <!-- Viewer Title & Description -->
                <div class="bg-slate-800 p-3 mb-2 rounded-xl text-center">
                    <h2 id="viewer-title" class="text-xl font-bold text-indigo-400">Loading Initial Dataset...</h2>
                    <p class="text-sm text-slate-400">Main Viewer (Simulated Gigapixel Tiling)</p>
                </div>

                <!-- OpenSeadragon Viewer -->
                <div id="viewers-wrapper" class="flex-grow">
                    <div id="viewer-main" class="osd-viewer flex-grow"></div>
                </div>
            </section>
        </main>
    </div>

    <!-- Firebase Imports and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = 'anon_loading';
        let viewer; 
        let isFirebaseActive = false; // Flag to check if DB is initialized

        /*
        *** NASA IMAGE DATASETS (Using the test link across all spots) ***
        */
        const testImageUrl = 'https://images-assets.nasa.gov/image/carina_nebula/carina_nebula~medium.jpg';

        const imageDatasets = {
            'image1': {
                title: 'NGC 3372: The Carina Nebula (Test Link)',
                source: testImageUrl
            },
            'image2': {
                title: 'Pillars of Creation - Eagle Nebula (Test Link)',
                source: testImageUrl
            },
            'image3': {
                title: 'Jupiter Cloud Systems - NASA Juno Mission (Test Link)',
                source: testImageUrl
            },
            'image4': {
                title: 'NGC 2070: The Tarantula Nebula (Test Link)',
                source: testImageUrl
            }
        };

        // --- Core Application State Switching ---
        window.startApp = function() {
            // Smoothly transition from landing page to main app
            document.getElementById('landing-page').style.opacity = '0';
            document.body.style.overflowY = 'auto'; // Allow scrolling once app is loaded
            
            setTimeout(() => {
                document.getElementById('landing-page').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('main-app').style.opacity = '1';
                // Initialize the main application components (Firebase, Viewer)
                initFirebase();
            }, 500); // Wait for fade-out transition
        }


        // --- Core Firebase Initialization and Auth ---
        async function initFirebase() {
            const errorDiv = document.getElementById('firestore-error');
            
            // Check for missing configuration and disable labeling if not present
            if (!firebaseConfig) {
                errorDiv.textContent = `DB Warning: Firebase config missing. Labeling disabled.`;
                errorDiv.classList.remove('hidden');
                console.warn("Firebase configuration is missing. Collaborative features are disabled.");
                // Ensure viewer still initializes even if DB is off
                initViewer(); 
                // Disable the labeling button visually
                document.getElementById('add-label-btn').disabled = true;
                document.getElementById('add-label-btn').classList.replace('bg-green-600', 'bg-gray-600');
                document.getElementById('add-label-btn').classList.remove('hover:bg-green-700');
                return; 
            }

            try {
                setLogLevel('Debug');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                isFirebaseActive = true; // Set flag to true

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id').textContent = userId.substring(0, 10) + '...';
                        console.log("Firebase Auth Ready. User ID:", userId);
                        initViewer();
                        setupLabelListener();
                    } else {
                        document.getElementById('user-id').textContent = 'Anonymous';
                        console.error("User not signed in.");
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                errorDiv.textContent = `DB Error: ${error.message}`;
                errorDiv.classList.remove('hidden');
            }
        }

        // --- OpenSeadragon Initialization (Single Viewer) ---
        function initViewer() {
            // Load the default image for the main viewer
            const initialDataset = imageDatasets['image1'];
            document.getElementById('viewer-title').textContent = initialDataset.title;

            viewer = OpenSeadragon({
                id: "viewer-main",
                prefixUrl: "https://openseadragon.github.io/openseadragon/images/",
                tileSources: { type: 'image', url: initialDataset.source },
                showNavigator: true,
                navigatorPosition: 'BOTTOM_RIGHT',
                preserveViewport: true,
                autoHideControls: false,
                minZoomLevel: 0.1,
            });
        }

        // --- Feature: Local Coordinate Search ---
        window.searchCoordinates = function() {
            if (!viewer) return;
            const input = document.getElementById('coord-search').value.trim();
            const feedback = document.getElementById('search-feedback');

            // Expects X, Y, [Zoom]
            const match = input.match(/(\d+\.?\d*)\s*,\s*(\d+\.?\d*)\s*(?:,\s*(\d+\.?\d*))?/);
            
            if (match) {
                const x = parseFloat(match[1]);
                const y = parseFloat(match[2]);
                const zoom = match[3] ? parseFloat(match[3]) : 3; 

                if (x >= 0 && x <= 1 && y >= 0 && y <= 1 && zoom > 0) {
                    const point = new OpenSeadragon.Point(x, y);
                    viewer.viewport.panTo(point, true);
                    viewer.viewport.zoomTo(zoom, true);
                    
                    feedback.textContent = `Success! Panning to (X: ${x.toFixed(2)}, Y: ${y.toFixed(2)}) at Zoom:${zoom.toFixed(1)}`;
                    feedback.classList.replace('text-red-400', 'text-slate-400');
                    return;
                }
            }

            feedback.textContent = "Error: Invalid format. Use X, Y, [Zoom] (e.g., 0.5, 0.5, 3.0). Coords 0.0-1.0.";
            feedback.classList.replace('text-slate-400', 'text-red-400');
        };

        // --- Feature: Image Switching Function ---
        window.loadNewImage = function(id) {
            if (!viewer) return;
            const dataset = imageDatasets[id];
            if (!dataset) return;
            
            viewer.open({ type: 'image', url: dataset.source });
            document.getElementById('viewer-title').textContent = dataset.title;
            
            // Reset multispectral filters
            document.getElementById('viewer-main').style.filter = 'none';
            document.getElementById('layer-ir').checked = false;
            document.getElementById('layer-alt').checked = false;
        }
        
        // --- Feature: Multispectral Layer Simulation ---
        window.toggleMultispectralLayer = function(layerName) {
            const layerState = document.getElementById(`layer-${layerName.toLowerCase()}`).checked;
            
            const mainViewerElement = document.getElementById('viewer-main');

            if (layerName === 'IR') {
                mainViewerElement.style.filter = layerState ? 'hue-rotate(180deg) saturate(200%)' : 'none';
                document.getElementById('layer-alt').checked = false;
            } else if (layerName === 'Altimetry') {
                mainViewerElement.style.filter = layerState ? 'grayscale(100%) brightness(150%)' : 'none';
                document.getElementById('layer-ir').checked = false;
            }

            if (!document.getElementById('layer-ir').checked && !document.getElementById('layer-alt').checked) {
                mainViewerElement.style.filter = 'none';
            }
        };

        // --- Community Labeling (Firestore Implementation) ---
        
        function setupLabelListener() {
            if (!isFirebaseActive) return;

            const labelsRef = collection(db, `artifacts/${appId}/public/data/labels`);
            const q = query(labelsRef);

            onSnapshot(q, (snapshot) => {
                const labelsList = document.getElementById('labels-list');
                labelsList.innerHTML = '';
                const labels = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    labels.push({ id: doc.id, ...data });
                });

                document.getElementById('label-count').textContent = `Total community labels: ${labels.length}`;

                if (viewer && viewer.world) {
                    viewer.clearOverlays();
                }

                labels.forEach(label => {
                    // Add to list in control panel
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-2 bg-slate-700 rounded-md hover:bg-slate-600 cursor-pointer transition';
                    item.innerHTML = `
                        <span class="text-sm text-slate-200 truncate">${label.text}</span>
                        <button onclick="zoomToLabel('${label.x}', '${label.y}')" class="text-xs text-indigo-400 hover:text-indigo-300 ml-2 flex items-center">
                            <i class="ph-bold ph-eye mr-1"></i> View
                        </button>
                    `;
                    labelsList.appendChild(item);

                    // Add marker overlay to the OpenSeadragon viewer
                    const marker = document.createElement('div');
                    marker.className = 'label-marker absolute w-3 h-3 bg-red-500 rounded-full border-2 border-white cursor-pointer';
                    marker.title = `Community Label: ${label.text}`;
                    marker.onclick = () => { window.zoomToLabel(label.x, label.y); };

                    const viewerPoint = new OpenSeadragon.Point(label.x, label.y);
                    
                    viewer.addOverlay({
                        element: marker,
                        location: viewerPoint,
                        placement: OpenSeadragon.Placement.CENTER
                    });
                });
            }, (error) => {
                console.error("Firestore error reading labels: ", error);
                document.getElementById('firestore-error').textContent = `DB Error: ${error.code}`;
                document.getElementById('firestore-error').classList.remove('hidden');
            });
        }

        window.zoomToLabel = function(x, y) {
            if (viewer) {
                const point = new OpenSeadragon.Point(parseFloat(x), parseFloat(y));
                viewer.viewport.panTo(point, true);
                viewer.viewport.zoomTo(3, true);
            }
        }

        window.addCommunityLabel = async function() {
            const labelInput = document.getElementById('label-text');
            const labelText = labelInput.value.trim();

            labelInput.classList.remove('border-red-500', 'border-2');

            if (labelText.length < 1) {
                labelInput.classList.add('border-red-500', 'border-2');
                console.error("Label must contain at least 1 character.");
                return;
            }
            
            if (!isFirebaseActive) {
                console.error("Firebase is not active. Cannot add label.");
                const errorDiv = document.getElementById('firestore-error');
                errorDiv.textContent = `Error: Labeling is disabled (missing Firebase config).`;
                errorDiv.classList.remove('hidden');
                return;
            }

            const centerPoint = viewer.viewport.getCenter();

            try {
                const labelsRef = collection(db, `artifacts/${appId}/public/data/labels`);
                await addDoc(labelsRef, {
                    text: labelText,
                    x: centerPoint.x,
                    y: centerPoint.y,
                    authorId: userId,
                    timestamp: serverTimestamp()
                });
                labelInput.value = '';
                console.log("Label added successfully at:", centerPoint.x, centerPoint.y);
            } catch (error) {
                console.error("Error adding label to Firestore: ", error);
                 const errorDiv = document.getElementById('firestore-error');
                 errorDiv.textContent = `Label Save Error: ${error.message}`;
                 errorDiv.classList.remove('hidden');
            }
        }
        
        // No window.onload needed, as the app starts by showing the landing page.
        // The main app (initFirebase/initViewer) is called only when the user clicks 'Begin Exploration'.
    </script>
</body>
</html>
