<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StellarScope: NASA Gigapixel Image Explorer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load OpenSeadragon for deep zoom functionality -->
    <script src="https://cdn.jsdelivr.net/npm/openseadragon@4.1.1/build/openseadragon/openseadragon.min.js"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Load Phosphor Icons for a modern look -->
    <script src="https://unpkg.com/phosphor-icons"></script>
    <style>
        /* General styling for dark mode */
        :root {
            --primary-color: #a5b4fc; /* Lavender/Light Purple */
            --dark-bg: #0f172a; /* Slate-900 */
            --dark-surface: #1e293b; /* Slate-800 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            color: #e2e8f0;
            /* Positioning context for the animated background */
            position: relative;
            overflow: hidden; /* Prevent animated background from causing scrollbars */
        }

        /* --- Animated Background CSS --- */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            /*
            *** INSTRUCTION: ADD BACKGROUND IMAGE HERE ***
            Replace the path below with a relative path to your background image (e.g., 'images/galaxy-bg.jpg').
            This image will be tiled and animated. If you don't want an image, remove the 'background-image' line.
            */
            background-image: url('YOUR_BACKGROUND_IMAGE_PATH_HERE');
            background-size: 50% auto; /* Smaller size to create a repeating pattern */
            background-repeat: repeat;
            opacity: 0.15; /* Subtly dim the background */
            z-index: -1; /* Place behind all content */
            animation: star-drift 120s linear infinite;
        }

        @keyframes star-drift {
            0% { transform: translate(0%, 0%); }
            100% { transform: translate(10%, 10%); } /* Slow drift diagonally */
        }
        /* --- End Animated Background CSS --- */

        /* --- Custom UI/LLM Loading CSS --- */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        /* Custom scrollbar for a cleaner dark look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--dark-surface);
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        /* Style for the OpenSeadragon viewers */
        .osd-viewer {
            width: 100%;
            height: 100%;
            background-color: #000;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        /* Styling for the control buttons */
        .control-btn {
            @apply flex items-center justify-center p-2 rounded-lg text-white font-medium transition duration-200;
        }
        .control-btn:hover {
             @apply shadow-md;
        }
        /* Ensure all primary containers are slightly transparent or dark to let the background show through */
        #app, header, main, aside, section {
             background-color: transparent !important; /* Reset background for structure */
        }
        /* Add slight transparency to functional panels */
        .bg-slate-800, .bg-slate-700 {
            background-color: rgba(30, 41, 59, 0.9) !important; /* Slate-800 with 90% opacity */
        }
        #status-panel {
            background-color: rgba(51, 65, 85, 0.9) !important; /* Slate-700 with 90% opacity */
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Main Application Container -->
    <div id="app" class="p-4 flex flex-col min-h-screen">
        <!-- Header -->
        <header class="mb-4 bg-slate-800 p-4 rounded-xl shadow-2xl">
            <h1 class="text-3xl font-extrabold text-indigo-400 flex items-center">
                <i class="ph-bold ph-planet mr-2 text-4xl"></i> StellarScope
                <span class="text-sm font-medium ml-3 text-slate-400 hidden sm:inline">NASA Deep Space Viewer</span>
            </h1>
        </header>

        <!-- Main Content Area: Sidebar (Controls) and Viewer -->
        <main class="flex-grow flex flex-col lg:flex-row gap-4">

            <!-- Sidebar / Control Panel -->
            <aside id="control-panel" class="bg-slate-800 p-4 rounded-xl shadow-lg w-full lg:w-80 lg:h-full flex-shrink-0 order-2 lg:order-1">
                <h2 class="text-xl font-semibold mb-4 text-indigo-300 border-b border-indigo-700 pb-2">Exploration Tools</h2>

                <!-- Status/User Info -->
                <div id="status-panel" class="mb-4 text-sm bg-slate-700 p-3 rounded-lg shadow">
                    <p class="font-medium text-slate-300">User ID: <span id="user-id" class="font-mono text-xs text-indigo-400">Loading...</span></p>
                    <p id="label-count" class="text-xs text-slate-400 mt-1">Total community labels: 0</p>
                    <div id="firestore-error" class="text-red-400 text-xs mt-1 hidden"></div>
                </div>

                <!-- Feature: AI Search & Navigation (Enhanced with Gemini) -->
                <div class="mb-6">
                    <h3 class="font-semibold text-lg mb-2 text-slate-200">AI Search & Coordinates</h3>
                    <input id="ai-search" type="text" placeholder="Search: 'What are galactic dust lanes?'"
                           class="w-full p-2 rounded-lg bg-slate-700 text-slate-50 border border-slate-600 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                    <button onclick="runAIQuery()" class="w-full mt-2 control-btn bg-indigo-500 hover:bg-indigo-600">
                        <i class="ph-fill ph-magnifying-glass mr-2"></i> Run AI Query ✨
                    </button>
                    <!-- Output area for all LLM responses -->
                    <div id="ai-response-area" class="text-xs mt-2 text-slate-400 italic min-h-6">
                        <!-- Responses and sources appear here -->
                    </div>
                    <!-- Loading Indicator -->
                    <div id="ai-loading-indicator" class="text-xs mt-2 text-indigo-400 hidden">
                        <i class="ph-bold ph-spinner spinner mr-1"></i> Analyzing data...
                    </div>
                </div>

                <!-- Feature: Intelligent Discovery (New Gemini Feature) -->
                <div class="mb-6">
                    <h3 class="font-semibold text-lg mb-2 text-slate-200">✨ Intelligent Discovery</h3>
                    <p class="text-xs text-slate-400 mb-2">Generate a concise, grounded summary of the object currently in the main viewer.</p>
                    <button onclick="runIntelligentDiscovery()" class="w-full control-btn bg-purple-600 hover:bg-purple-700">
                        <i class="ph-fill ph-sparkle mr-2"></i> Describe Current View
                    </button>
                </div>

                <!-- Feature: Image Switching Gallery (New Feature) -->
                <div class="mb-6">
                    <h3 class="font-semibold text-lg mb-2 text-slate-200">Image Gallery</h3>
                    <p class="text-xs text-slate-400 mb-2">Instantly load a new dataset into the main viewer.</p>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="loadNewImage('deep_field')" class="control-btn bg-green-800 hover:bg-green-700 text-sm">
                            <i class="ph-bold ph-galaxy mr-1"></i> Galaxy View
                        </button>
                        <button onclick="loadNewImage('hubble_cutout')" class="control-btn bg-green-800 hover:bg-green-700 text-sm">
                            <i class="ph-bold ph-star-four mr-1"></i> HST Cutout
                        </button>
                        <button onclick="loadNewImage('fits_cut')" class="control-btn bg-green-800 hover:bg-green-700 text-sm">
                            <i class="ph-bold ph-grid-four mr-1"></i> Starfield Grid
                        </button>
                        <button onclick="loadNewImage('mars_placeholder')" class="control-btn bg-green-800 hover:bg-green-700 text-sm">
                            <i class="ph-bold ph-globe mr-1"></i> Planet Map
                        </button>
                    </div>
                </div>


                <!-- Feature: Multispectral Layers -->
                <div class="mb-6">
                    <h3 class="font-semibold text-lg mb-2 text-slate-200">Multispectral Layers</h3>
                    <div class="flex flex-col space-y-2">
                        <label class="flex items-center text-sm text-slate-300">
                            <input type="checkbox" id="layer-rgb" checked disabled class="rounded text-indigo-500 bg-slate-700 border-slate-600 mr-2">
                            Standard (RGB)
                        </label>
                        <label class="flex items-center text-sm text-slate-300">
                            <input type="checkbox" id="layer-ir" onclick="toggleMultispectralLayer('IR')" class="rounded text-indigo-500 bg-slate-700 border-slate-600 mr-2">
                            Infrared (IR) <span class="text-xs ml-2 text-yellow-400">(Simulated)</span>
                        </label>
                        <label class="flex items-center text-sm text-slate-300">
                            <input type="checkbox" id="layer-alt" onclick="toggleMultispectralLayer('Altimetry')" class="rounded text-indigo-500 bg-slate-700 border-slate-600 mr-2">
                            Altimetry
                        </label>
                    </div>
                </div>

                <!-- Feature: Time-based Exploration Toggle -->
                <div class="mb-6">
                    <h3 class="font-semibold text-lg mb-2 text-slate-200">Time Comparison</h3>
                    <button id="toggle-comparison" onclick="toggleComparisonView()" class="w-full control-btn bg-yellow-600 hover:bg-yellow-700">
                        <i class="ph-bold ph-columns mr-2"></i> Enable Side-by-Side
                    </button>
                    <p class="text-xs mt-2 text-slate-400 italic">Compare images from different epochs.</p>
                </div>

                <!-- Feature: Labeling & Discovery -->
                <div class="mb-6">
                    <h3 class="font-semibold text-lg mb-2 text-slate-200">Community Labeling</h3>
                    <input id="label-text" type="text" placeholder="Enter feature name (e.g. 'New Crater')"
                           class="w-full p-2 rounded-lg bg-slate-700 text-slate-50 border border-slate-600 focus:ring-indigo-500 focus:border-indigo-500 text-sm mb-2">
                    <button onclick="addCommunityLabel()" class="w-full control-btn bg-green-600 hover:bg-green-700">
                        <i class="ph-fill ph-push-pin-simple mr-2"></i> Add Label at Center
                    </button>
                    <div id="labels-list" class="mt-3 max-h-40 overflow-y-auto space-y-1">
                        <!-- Labels will be dynamically injected here -->
                    </div>
                </div>

            </aside>

            <!-- Viewer Area (Main Content) -->
            <section id="viewer-container" class="flex-grow min-h-[60vh] lg:min-h-full flex flex-col order-1 lg:order-2">
                <!-- Viewer Title & Description -->
                <div class="bg-slate-800 p-3 mb-2 rounded-xl text-center">
                    <!-- UPDATED TITLE to reflect the new main image -->
                    <h2 id="viewer-title" class="text-xl font-bold text-indigo-400">Deep Field Survey: High-Resolution Galaxy View</h2>
                    <p class="text-sm text-slate-400">Main Viewer (Simulated Gigapixel Tiling)</p>
                </div>

                <!-- OpenSeadragon Viewers -->
                <div id="viewers-wrapper" class="flex-grow flex flex-col md:flex-row gap-4">
                    <div id="viewer-main" class="osd-viewer flex-grow"></div>
                    <div id="viewer-comparison" class="osd-viewer flex-grow hidden"></div>
                </div>
            </section>
        </main>
    </div>

    <!-- Firebase Imports and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = 'anon_loading';
        let viewer, viewerComp; // OpenSeadragon instances

        // API Configuration
        const GEMINI_MODEL = 'gemini-2.5-flash-preview-05-20';
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=`;
        const apiKey = ""; // Canvas handles the key when this is empty.

        /*
        *** INSTRUCTION: ADD YOUR IMAGE DATASETS HERE ***

        To add your own images, replace the 'source' value below with a relative file path
        (e.g., 'images/my_new_galaxy.jpg'). Make sure the images are in a subfolder named 'images'
        or adjust the path accordingly when running locally.

        The OpenSeadragon viewer will use these simple image paths to simulate deep zoom.
        */
        const imageDatasets = {
            'deep_field': {
                title: 'Deep Field Survey: High-Resolution Galaxy View',
                source: 'curious-universe-earth-cropped.webp' // <-- REPLACE THIS PATH
            },
            'hubble_cutout': {
                title: 'HST Deep Field Cutout: Filter 606W (Faint Stars)',
                source: 'curious-universe-earth-cropped.webp' // <-- REPLACE THIS PATH
            },
            'fits_cut': {
                title: 'FITS Cutout: Extreme Density Starfield',
                source: 'curious-universe-earth-cropped.webp' // <-- REPLACE THIS PATH
            },
            'mars_placeholder': {
                title: 'Mars Global Map (Simulated Altimetry)',
                source: 'curious-universe-earth-cropped.webp' // <-- REPLACE THIS PATH
            }
        };


        // --- Utility Functions for LLM Interaction ---
        const showLoading = (show) => {
            document.getElementById('ai-loading-indicator').classList.toggle('hidden', !show);
            // Clear the response area when loading starts
            if (show) {
                document.getElementById('ai-response-area').innerHTML = '';
            }
        };

        const displayError = (message) => {
            document.getElementById('ai-response-area').innerHTML = `<span class="text-red-400">Error: ${message}</span>`;
        };

        // --- Reusable Gemini API Call with Backoff ---
        async function makeGeminiCall(payload, retries = 3, delay = 1000) {
            showLoading(true);
            const fullApiUrl = API_URL + apiKey;

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(fullApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        showLoading(false);
                        return result;
                    } else if (response.status === 429 && i < retries - 1) {
                        // Rate limit, try again with exponential backoff
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Double the delay
                    } else {
                        const errorBody = await response.json();
                        throw new Error(errorBody.error?.message || `API request failed with status ${response.status}`);
                    }
                } catch (error) {
                    if (i === retries - 1) {
                        showLoading(false);
                        throw new Error(error.message || `Failed to call Gemini API after ${retries} attempts.`);
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }


        // --- Core Firebase Initialization and Auth ---
        async function initFirebase() {
            try {
                if (!firebaseConfig) {
                    throw new Error("Firebase configuration is missing.");
                }
                setLogLevel('Debug');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in using the provided token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id').textContent = userId.substring(0, 10) + '...';
                        console.log("Firebase Auth Ready. User ID:", userId);
                        initViewers();
                        setupLabelListener(); // Start listening for community labels
                    } else {
                        // This should ideally not happen if signInAnonymously is used
                        document.getElementById('user-id').textContent = 'Anonymous';
                        console.error("User not signed in.");
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                const errorDiv = document.getElementById('firestore-error');
                errorDiv.textContent = `DB Error: ${error.message}`;
                errorDiv.classList.remove('hidden');
            }
        }

        // --- OpenSeadragon Initialization ---
        function initViewers() {
            // Source for main viewer starts with the default 'deep_field' image from the dataset
            const initialSource = {
                type: 'image',
                url: imageDatasets.deep_field.source,
            };

            viewer = OpenSeadragon({
                id: "viewer-main",
                prefixUrl: "https://openseadragon.github.io/openseadragon/images/",
                tileSources: initialSource,
                showNavigator: true,
                navigatorPosition: 'BOTTOM_RIGHT',
                sequenceMode: false,
                preserveViewport: true,
                autoHideControls: false,
                minZoomLevel: 0.1,
            });

            /*
            *** INSTRUCTION: COMPARISON IMAGE 1 PATH ***
            Set the first comparison image source (used for Time Comparison mode).
            */
            const comparisonSource1 = {
                type: 'image',
                url: 'images/comparison-time-0.jpg', // <-- REPLACE THIS PATH
            };
            
            viewerComp = OpenSeadragon({
                id: "viewer-comparison",
                prefixUrl: "https://openseadragon.github.io/openseadragon/images/",
                tileSources: comparisonSource1,
                showNavigator: true,
                navigatorPosition: 'BOTTOM_RIGHT',
                sequenceMode: false,
                preserveViewport: true,
                autoHideControls: false,
                minZoomLevel: 0.1,
            });

            // Synchronize viewports when in comparison mode
            viewer.addHandler('viewport-change', (e) => {
                if (!document.getElementById('viewer-comparison').classList.contains('hidden')) {
                    viewerComp.viewport.setViewpoint(e.eventSource.viewport.getBounds());
                }
            });
            viewerComp.addHandler('viewport-change', (e) => {
                 if (!document.getElementById('viewer-comparison').classList.contains('hidden')) {
                    viewer.viewport.setViewpoint(e.eventSource.viewport.getBounds());
                }
            });

            /*
            *** INSTRUCTION: COMPARISON IMAGE 2 PATH ***
            Set the second comparison image source (used for Time Comparison mode).
            */
            window.comparisonSource2 = {
                type: 'image',
                url: 'images/comparison-time-1.jpg', // <-- REPLACE THIS PATH
            };
        }

        // --- Image Switching Function ---
        window.loadNewImage = function(id) {
            if (!viewer) return;
            const dataset = imageDatasets[id];
            if (!dataset) return;
            
            // 1. Clear comparison mode if active
            if (!document.getElementById('viewer-comparison').classList.contains('hidden')) {
                window.toggleComparisonView(); 
            }

            // 2. Load the new image and update title
            viewer.open({ type: 'image', url: dataset.source });
            document.getElementById('viewer-title').textContent = dataset.title;
            
            // 3. Reset multispectral filters
            document.getElementById('viewer-main').style.filter = 'none';
            document.getElementById('layer-ir').checked = false;
            document.getElementById('layer-alt').checked = false;
        }

        // --- Feature 1: Time Comparison Toggle ---
        window.toggleComparisonView = function() {
            const wrapper = document.getElementById('viewers-wrapper');
            const compViewerDiv = document.getElementById('viewer-comparison');
            const button = document.getElementById('toggle-comparison');

            if (compViewerDiv.classList.contains('hidden')) {
                // Entering Comparison Mode
                compViewerDiv.classList.remove('hidden');
                wrapper.classList.add('md:flex-row');
                wrapper.classList.remove('flex-col');
                button.textContent = ' Disable Side-by-Side';
                button.classList.replace('bg-yellow-600', 'bg-red-600');

                document.getElementById('viewer-title').textContent = 'Time Comparison Mode: Before vs. After';
                
                // Load the two specific comparison images defined in initViewers
                viewer.open({ type: 'image', url: 'images/comparison-time-0.jpg' });
                viewerComp.open(window.comparisonSource2); 
                
            } else {
                // Exiting Comparison Mode
                compViewerDiv.classList.add('hidden');
                wrapper.classList.add('flex-col');
                wrapper.classList.remove('md:flex-row');
                button.textContent = ' Enable Side-by-Side';
                button.classList.replace('bg-red-600', 'bg-yellow-600');

                // Return to the default galaxy image
                document.getElementById('viewer-title').textContent = imageDatasets.deep_field.title;
                viewer.open({ type: 'image', url: imageDatasets.deep_field.source });
            }
            viewer.viewport.zoomTo(viewer.viewport.getZoom());
            viewerComp.viewport.zoomTo(viewerComp.viewport.getZoom());
        };

        // --- Feature 2: AI-Assisted Query Enhancement (LLM Integration) ---
        function simulateZoomAction(query) {
            const q = query.toLowerCase();
            let zoomMessage = '';
            
            if (viewer) {
                if (q.includes('galaxy') || q.includes('andromeda')) {
                    viewer.viewport.panTo(new OpenSeadragon.Point(0.5, 0.5), true);
                    viewer.viewport.zoomTo(1.5, true); 
                    zoomMessage = '✨ Auto-focusing viewer on the central galactic core...';
                } else if (q.includes('dust') || q.includes('nebula') || q.includes('filament')) {
                    viewer.viewport.panTo(new OpenSeadragon.Point(0.1, 0.8), true);
                    viewer.viewport.zoomTo(4, true); 
                    zoomMessage = '✨ Initiating deep zoom to region of interest to detect low-contrast dust features...';
                } else if (q.includes('star') || q.includes('cluster') || q.includes('quasar')) {
                    viewer.viewport.panTo(new OpenSeadragon.Point(0.8, 0.2), true);
                    viewer.viewport.zoomTo(8, true); 
                    zoomMessage = '✨ Pinpointing high-magnification area to resolve individual star data...';
                } else {
                    viewer.viewport.panTo(new OpenSeadragon.Point(0.5, 0.5), true);
                    viewer.viewport.zoomTo(1, true);
                    zoomMessage = '✨ Search processed. Reverting to full field of view.';
                }
            } else {
                zoomMessage = 'Viewers are not yet initialized. Please wait.';
            }
            return zoomMessage;
        }

        window.runAIQuery = async function() {
            const query = document.getElementById('ai-search').value;
            document.getElementById('ai-response-area').innerHTML = '';

            if (query.trim().length < 5) {
                displayError("Please enter a scientific query (e.g., 'What are star forming regions?').");
                return;
            }

            // 1. Generate description based on the query using the LLM
            const userPrompt = `Analyze the search query: "${query}". Provide a detailed, single-paragraph explanation of the scientific concept or celestial object the user is looking for. Do not include coordinates.`;

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: "You are an expert scientific search analyst. You must provide a contextual and accurate explanation for the user's query, using search grounding to ensure accuracy." }]
                },
            };

            try {
                const result = await makeGeminiCall(payload);
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    let text = candidate.content.parts[0].text;
                    
                    // 2. Simulate the zoom action after receiving the LLM text
                    const zoomText = simulateZoomAction(query);

                    document.getElementById('ai-response-area').innerHTML = `
                        <div class="text-slate-200">${text}</div>
                        <p class="text-xs mt-2 text-indigo-400">${zoomText}</p>
                    `;

                } else {
                    displayError("Could not process the query.");
                }
            } catch (error) {
                displayError(error.message || "An unknown error occurred during AI search.");
            }
        };

        // --- Feature 3: Intelligent Discovery (LLM Integration) ---
        window.runIntelligentDiscovery = async function() {
            const title = document.getElementById('viewer-title').textContent;
            document.getElementById('ai-response-area').innerHTML = '';

            const userQuery = `Provide a single, short paragraph (under 80 words) summarizing the key facts, name, and location of the celestial object named in the following viewer title. Ignore the word 'Simulated' in the title. Title: ${title}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: "You are a concise, world-class space historian and astrophysicist. Only provide facts found using Google Search grounding, presented clearly and professionally." }]
                },
            };

            try {
                const result = await makeGeminiCall(payload);
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    let text = candidate.content.parts[0].text;
                    let sources = [];

                    // Extract Grounding Sources
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attr => ({ uri: attr.web?.uri, title: attr.web?.title }))
                            .filter(source => source.uri && source.title);
                    }

                    // Append text with a source indicator
                    let sourceHtml = '';
                    if (sources.length > 0) {
                        sourceHtml = `<span class="text-indigo-300 block mt-2">Sources: ${sources.map((s, i) => `<a href="${s.uri}" target="_blank" class="hover:underline text-xs" style="text-decoration: none;">[${i + 1}]</a>`).join(' ')}</span>`;
                    }
                    
                    document.getElementById('ai-response-area').innerHTML = `
                        <div class="text-slate-200">${text}</div>${sourceHtml}
                    `;
                } else {
                    displayError("Could not generate description. Please try again.");
                }
            } catch (error) {
                displayError(error.message || "An unknown error occurred during AI discovery.");
            }
        };

        // --- Community Labeling (Existing Firestore Implementation) ---

        function setupLabelListener() {
            if (!db) return;
            const labelsRef = collection(db, `artifacts/${appId}/public/data/labels`);
            const q = query(labelsRef);

            onSnapshot(q, (snapshot) => {
                const labelsList = document.getElementById('labels-list');
                labelsList.innerHTML = '';
                const labels = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    labels.push({ id: doc.id, ...data });
                });

                document.getElementById('label-count').textContent = `Total community labels: ${labels.length}`;

                // Clear existing overlays before adding new ones
                if (viewer && viewer.world) {
                    viewer.clearOverlays();
                }

                labels.forEach(label => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-2 bg-slate-700 rounded-md hover:bg-slate-600 cursor-pointer transition';
                    item.innerHTML = `
                        <span class="text-sm text-slate-200 truncate">${label.text}</span>
                        <button onclick="zoomToLabel('${label.x}', '${label.y}')" class="text-xs text-indigo-400 hover:text-indigo-300 ml-2 flex items-center">
                            <i class="ph-bold ph-eye mr-1"></i> View
                        </button>
                    `;
                    labelsList.appendChild(item);

                    // Add markers to the viewer (OpenSeadragon supports overlays)
                    const marker = document.createElement('div');
                    marker.className = 'label-marker absolute w-3 h-3 bg-red-500 rounded-full border-2 border-white cursor-pointer';
                    marker.title = `Community Label: ${label.text}`;
                    marker.onclick = () => {
                        window.zoomToLabel(label.x, label.y);
                    };

                    const viewerPoint = new OpenSeadragon.Point(label.x, label.y);
                    
                    viewer.addOverlay({
                        element: marker,
                        location: viewerPoint,
                        placement: OpenSeadragon.Placement.CENTER
                    });
                });
            }, (error) => {
                console.error("Firestore error reading labels: ", error);
                document.getElementById('firestore-error').textContent = `DB Error: ${error.code}`;
                document.getElementById('firestore-error').classList.remove('hidden');
            });
        }

        window.zoomToLabel = function(x, y) {
            if (viewer) {
                const point = new OpenSeadragon.Point(parseFloat(x), parseFloat(y));
                viewer.viewport.panTo(point, true);
                viewer.viewport.zoomTo(3, true);
            }
        }

        window.addCommunityLabel = async function() {
            if (!db || !viewer) return;

            const labelInput = document.getElementById('label-text');
            const labelText = labelInput.value.trim();

            if (labelText.length < 3) {
                console.error("Label too short.");
                return;
            }

            const centerPoint = viewer.viewport.getCenter();

            try {
                const labelsRef = collection(db, `artifacts/${appId}/public/data/labels`);
                await addDoc(labelsRef, {
                    text: labelText,
                    x: centerPoint.x,
                    y: centerPoint.y,
                    authorId: userId,
                    timestamp: serverTimestamp()
                });
                labelInput.value = '';
                console.log("Label added successfully at:", centerPoint.x, centerPoint.y);
            } catch (error) {
                console.error("Error adding label to Firestore: ", error);
                 const errorDiv = document.getElementById('firestore-error');
                 errorDiv.textContent = `Label Save Error: ${error.message}`;
                 errorDiv.classList.remove('hidden');
            }
        }

        // --- Start Application ---
        window.onload = function() {
            initFirebase();
        };

    </script>
</body>
</html>
